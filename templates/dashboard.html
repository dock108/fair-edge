{% extends "base.html" %}

{% block title %}Sports Betting Dashboard - Live Expected Value Analysis{% endblock %}

{% block head %}
<meta name="description" content="Educational sports betting analysis tool for research and comparison of odds across multiple sportsbooks. For educational purposes only.">
<meta name="keywords" content="sports betting, odds comparison, betting analysis, EV calculator, educational tool">
{% endblock %}

{% block content %}
<!-- Skip Link for Accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

{% if admin_mode %}
<!-- Debug Mode Indicator -->
<div class="debug-mode-indicator" role="status" aria-live="polite">
    üêõ DEBUG MODE ACTIVE
</div>
{% endif %}

{% if admin_mode %}
<!-- Admin Mode Debug Panel -->
<div class="admin-debug-panel">
    <div class="container-fluid">
        <div class="debug-header">
            <h2><i class="fas fa-cog me-2"></i>Developer Debug Mode</h2>
            <p class="text-muted">This panel is only visible to administrators and contains diagnostic information.</p>
        </div>
        
        <details class="debug-section">
            <summary class="debug-summary">
                <i class="fas fa-chart-line me-2"></i>System Metrics & Performance
            </summary>
            <div class="debug-content">
                <div class="row">
                    <div class="col-md-6">
                        <h4>System Information</h4>
                        <div class="debug-data">
                            <strong>App Version:</strong> {{ debug_info.system_metrics.app_version }}<br>
                            <strong>Environment:</strong> {{ debug_info.system_metrics.environment }}<br>
                            <strong>Python Version:</strong> {{ debug_info.system_metrics.python_version }}<br>
                            <strong>Debug Mode:</strong> {{ debug_info.system_metrics.debug_mode }}<br>
                            <strong>Timestamp:</strong> {{ debug_info.system_metrics.timestamp }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Performance Metrics</h4>
                        <div class="debug-data">
                            <strong>Page Generation:</strong> {{ debug_info.performance.page_generation_time_ms }}ms<br>
                            <strong>Data Cached:</strong> {{ debug_info.performance.data_fetch_cached }}<br>
                            <strong>Processing Time:</strong> {{ debug_info.performance.total_processing_time }}<br>
                            <strong>Memory Efficient:</strong> {{ debug_info.performance.memory_efficient }}
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details class="debug-section">
            <summary class="debug-summary">
                <i class="fas fa-database me-2"></i>Data Pipeline Summary
            </summary>
            <div class="debug-content">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Data Flow</h4>
                        <div class="debug-data">
                            <strong>Raw Events:</strong> {{ debug_info.data_summary.raw_events }}<br>
                            <strong>Processed Opportunities:</strong> {{ debug_info.data_summary.processed_opportunities }}<br>
                            <strong>UI Opportunities:</strong> {{ debug_info.data_summary.ui_opportunities }}<br>
                            <strong>Processing Time:</strong> {{ debug_info.data_summary.data_processing_time }}s
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h4>EV Distribution</h4>
                        <div class="debug-data">
                            <strong>Excellent (4.5%+):</strong> {{ debug_info.ev_distribution.excellent_count }}<br>
                            <strong>High (2.5%+):</strong> {{ debug_info.ev_distribution.high_count }}<br>
                            <strong>Positive:</strong> {{ debug_info.ev_distribution.positive_count }}<br>
                            <strong>Neutral/Negative:</strong> {{ debug_info.ev_distribution.neutral_negative_count }}<br>
                            <strong>Max EV:</strong> {{ debug_info.ev_distribution.max_ev|round(2) }}%<br>
                            <strong>Min EV:</strong> {{ debug_info.ev_distribution.min_ev|round(2) }}%<br>
                            <strong>Avg EV:</strong> {{ debug_info.ev_distribution.avg_ev|round(2) }}%
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h4>Filter State</h4>
                        <div class="debug-data">
                            <strong>Sport Filter:</strong> {{ debug_info.filter_state.sport_filter }}<br>
                            <strong>Market Filter:</strong> {{ debug_info.filter_state.market_filter }}<br>
                            <strong>Active Filters:</strong> {{ debug_info.filter_state.active_filters }}<br>
                            <strong>Cache Status:</strong> {{ debug_info.data_summary.cache_status }}
                        </div>
                    </div>
                </div>
            </div>
        </details>
    </div>
</div>
{% endif %}

<!-- ‚ñ∏ Hero Banner  -->
<section class="hero-ev">
  <div class="hero-ev__content container">
    <h1 class="hero-ev__title">
      <span class="icon">&#xf522;</span>  <!-- remove if you don't use FontAwesome -->
      Sports Betting <strong>+EV</strong> Analyzer
    </h1>
    <p class="hero-ev__tagline">
      Educational odds analysis and comparison tool
    </p>
    <p class="hero-ev__subtag">
      For research and educational purposes only
    </p>
  </div>
  <svg class="hero-ev__wave" viewBox="0 0 1440 60" aria-hidden="true">
    <path d="M0,30 C240,60 480,0 720,30 C960,60 1200,0 1440,30 L1440,60 L0,60 Z" fill="#fff"/>
  </svg>
</section>

<!-- Metrics Section -->
<section class="metrics-section" role="region" aria-labelledby="metrics-heading">
    <div class="container-fluid">
        <h2 id="metrics-heading" class="sr-only">Dashboard Metrics</h2>
        {% if filter_applied %}
        <div class="text-center mb-3" role="status" aria-live="polite">
            <span class="badge bg-info fs-6">
                <i class="fas fa-filter me-1" aria-hidden="true"></i>
                <span class="sr-only">Filters are active:</span>
                Filters Active
                {% if current_sport and current_sport != '' %} - Sport: {{ current_sport|title }}{% endif %}
                {% if current_market and current_market != '' %} - Market: {{ current_market|title }}{% endif %}
            </span>
        </div>
        {% endif %}
        <div class="row g-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="total-desc">{{ analytics.total_opportunities }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Total Opportunities
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Total number of betting opportunities found across all analyzed markets and sportsbooks
                            </div>
                        </span>
                    </div>
                    <div id="total-desc" class="sr-only">Total betting opportunities available</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="positive-desc">{{ analytics.positive_ev_count }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Positive EV Bets
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Bets with positive expected value - theoretically profitable opportunities based on our fair odds model
                            </div>
                        </span>
                    </div>
                    <div id="positive-desc" class="sr-only">Number of bets with positive expected value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="high-desc">{{ analytics.high_ev_count }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            High EV (4.5%+)
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Premium opportunities with 4.5% or higher expected value - our strongest betting recommendations
                            </div>
                        </span>
                    </div>
                    <div id="high-desc" class="sr-only">High expected value opportunities with 4.5% or greater edge</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="max-desc">{{ analytics.max_ev_percentage }}%</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Max EV Found
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                The highest expected value percentage found among all current opportunities
                            </div>
                        </span>
                    </div>
                    <div id="max-desc" class="sr-only">Maximum expected value percentage found</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Free Tier Upgrade Banner -->
{% if user_role == 'free' and role_metadata.truncated %}
<div class="container-fluid mt-4">
    <div id="upgrade-banner" class="alert alert-warning alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">
                <h4 class="alert-heading mb-2">
                    <i class="fas fa-star me-2" aria-hidden="true"></i>
                    Upgrade to Premium!
                </h4>
                <p class="mb-2">
                    <strong>You're seeing only {{ role_metadata.shown }} of {{ role_metadata.total_available }} available opportunities.</strong>
                    Upgrade to unlock full access to all betting opportunities with advanced analytics.
                </p>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Free Tier Includes:</h6>
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-check text-success me-1"></i> {{ role_metadata.limit }} opportunities</li>
                            <li><i class="fas fa-check text-success me-1"></i> Basic EV analysis</li>
                            <li><i class="fas fa-check text-success me-1"></i> {{ role_metadata.features.refresh_rate_minutes }}-minute updates</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Premium Features:</h6>
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-star text-warning me-1"></i> Full {{ role_metadata.total_available }}+ opportunities</li>
                            <li><i class="fas fa-star text-warning me-1"></i> Advanced analytics & confidence scoring</li>
                            <li><i class="fas fa-star text-warning me-1"></i> 5-minute refresh rate</li>
                            <li><i class="fas fa-star text-warning me-1"></i> Export capabilities</li>
                            <li><i class="fas fa-star text-warning me-1"></i> Custom filters & alerts</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="ms-3">
                <a href="/pricing" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-up me-2"></i>
                    Go Premium
                </a>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close upgrade banner"></button>
    </div>
</div>
{% endif %}

<!-- Filter Controls Section -->
<section class="filters-section" role="region" aria-labelledby="filters-heading">
    <div class="filters-container">
        <h2 id="filters-heading" class="sr-only">Filter Controls</h2>
        <form class="filters-form" method="get" role="search" aria-label="Filter betting opportunities">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="sport-filter" class="filter-label">Sport:</label>
                    <select name="sport" id="sport-filter" class="filter-select" aria-describedby="sport-help">
                        <option value="">All Sports</option>
                        <option value="basketball_nba" {% if current_sport == 'basketball_nba' %}selected{% endif %}>NBA Basketball</option>
                        <option value="americanfootball_nfl" {% if current_sport == 'americanfootball_nfl' %}selected{% endif %}>NFL Football</option>
                        <option value="baseball_mlb" {% if current_sport == 'baseball_mlb' %}selected{% endif %}>MLB Baseball</option>
                        <option value="icehockey_nhl" {% if current_sport == 'icehockey_nhl' %}selected{% endif %}>NHL Hockey</option>
                    </select>
                    <div id="sport-help" class="sr-only">Filter opportunities by specific sport or league</div>
                </div>
                
                <div class="filter-group">
                    <label for="market-filter" class="filter-label">Market:</label>
                    <select name="market" id="market-filter" class="filter-select" aria-describedby="market-help">
                        <option value="">All Markets</option>
                        <option value="h2h" {% if current_market == 'h2h' %}selected{% endif %}>Moneyline</option>
                        <option value="spreads" {% if current_market == 'spreads' %}selected{% endif %}>Point Spread</option>
                        <option value="totals" {% if current_market == 'totals' %}selected{% endif %}>Over/Under Totals</option>
                        <option value="player_props" {% if current_market == 'player_props' %}selected{% endif %}>Player Props</option>
                    </select>
                    <div id="market-help" class="sr-only">Filter opportunities by betting market type</div>
                </div>
                
                <div class="filter-group filter-actions">
                    <button type="submit" class="filter-btn filter-btn-apply btn-primary" aria-describedby="apply-help">
                        <i class="fas fa-search me-1" aria-hidden="true"></i>
                        Apply Filters
                    </button>
                    <a href="/" class="filter-btn filter-btn-clear btn-secondary" aria-describedby="clear-help">
                        <i class="fas fa-times me-1" aria-hidden="true"></i>
                        Clear Filters
                    </a>
                    <div id="apply-help" class="sr-only">Apply selected filters to update results</div>
                    <div id="clear-help" class="sr-only">Remove all filters and show all opportunities</div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Betting Opportunities Section -->
<main class="opportunities-section" id="main-content" role="main" aria-labelledby="opportunities-heading">
    <div class="main-container">
        <h2 id="opportunities-heading" class="sr-only">Betting Opportunities</h2>
        
        <!-- Real-time Update Loading Spinner -->
        <div id="loading-spinner" class="d-none text-center mb-3" role="status" aria-live="polite">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading new opportunities...</span>
            </div>
            <div class="mt-2 text-muted">
                <small><i class="fas fa-broadcast-tower me-1"></i>Receiving real-time updates...</small>
            </div>
        </div>
        
        {% if error %}
        <!-- Error State -->
        <div class="empty-state" role="alert" aria-live="assertive">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning" aria-hidden="true"></i>
            <h3>Unable to Load Data</h3>
            <p>{{ error }}</p>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-refresh me-1" aria-hidden="true"></i>
                Try Again
            </a>
        </div>
        
        {% elif opportunities|length == 0 %}
        <!-- Empty State -->
        <div class="empty-state" role="status" aria-live="polite">
            <i class="fas fa-search fa-3x mb-3 text-muted" aria-hidden="true"></i>
            <h3>No Opportunities Found</h3>
            <p>{% if filter_applied %}No betting opportunities match your current filters. Try adjusting your search criteria or clearing filters to see all available opportunities.{% else %}No betting opportunities are currently available. Please check back later.{% endif %}</p>
            {% if filter_applied %}
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-times me-1" aria-hidden="true"></i>
                Clear All Filters
            </a>
            {% endif %}
        </div>
        
        {% else %}
        <!-- Results Summary for Screen Readers -->
        <div class="sr-only" aria-live="polite" role="status">
            Showing {{ opportunities|length }} betting opportunities
            {% if filter_applied %}
                {% if current_sport %} for {{ current_sport|title }}{% endif %}
                {% if current_market %} in {{ current_market|title }} markets{% endif %}
            {% endif %}
        </div>
        
        <!-- Opportunities Grid -->
        <div class="cards-grid" role="list" aria-label="Betting opportunities">
            {% for opportunity in opportunities %}
            <article class="odds-card ev-{{ opportunity.ev_classification }}" role="listitem" 
                     aria-labelledby="card-{{ loop.index }}-title"
                     aria-describedby="card-{{ loop.index }}-recommended">
                
                <!-- Card Header -->
                <header class="odds-card__header">
                    <h2 class="odds-card__title" id="card-{{ loop.index }}-title">{{ opportunity.event }}</h2>
                    <p class="odds-card__subtitle">{{ opportunity.bet_description }}</p>
                </header>

                <!-- Card Body with Recommended Odds as Focal Point -->
                <div class="odds-card__body">
                    <!-- Recommended Posting Odds - PRIMARY FOCAL POINT -->
                    {% if opportunity.recommended_posting_odds != 'N/A' %}
                    <div class="odds-card__recommended" id="card-{{ loop.index }}-recommended">
                        <span class="recommended-label">
                            <span class="tooltip-container">
                                Recommended Posting Odds:
                                <button class="help-icon" aria-label="Posting Odds Help" type="button" tabindex="0">?</button>
                                <div class="tooltip tooltip-large" role="tooltip">
                                    Recommended odds to post on betting exchanges to achieve at least 2.5% expected value after commission fees.
                                </div>
                            </span>
                        </span>
                        <span class="recommended-value" aria-label="Recommended posting odds: {{ opportunity.recommended_posting_odds }}">
                            {{ opportunity.recommended_posting_odds }}
                        </span>
                        
                        <!-- Action Buttons under Recommended Odds -->
                        {% if opportunity._original.Links and opportunity._original.Links != 'N/A' %}
                        <div class="action-buttons" role="group" aria-label="Betting actions">
                            {% for link in opportunity._original.Links.split('|') %}
                                {% if link.strip() %}
                                    {% set link_parts = link.strip().split(':') %}
                                    {% if link_parts|length >= 2 %}
                                        {% set action_type = link_parts[0].strip() %}
                                        {% set action_url = link_parts[1:]|join(':')|trim %}
                                        {% if action_type == 'Post' %}
                                        <a href="{{ action_url }}" 
                                           class="odds-card__action-btn post" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           aria-label="Post bet - opens in new window">
                                            <i class="fas fa-plus me-1" aria-hidden="true"></i>
                                            Post Bet
                                        </a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Other Odds Details - Secondary Information -->
                    <div class="odds-card__details">
                        <!-- Fair Odds -->
                        <div class="detail-item">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Fair Odds:
                                    <button class="help-icon" aria-label="Fair Odds Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        The true odds calculated by our model. If available odds are better than this, the bet has positive expected value.
                                    </div>
                                </span>
                            </span>
                            <span class="detail-value" aria-label="Fair odds: {{ opportunity.fair_odds }}">
                                {{ opportunity.fair_odds }}
                            </span>
                        </div>

                        <!-- Best Available Odds -->
                        <div class="detail-item">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Best Available:
                                    <button class="help-icon" aria-label="Best Odds Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        The best odds currently available across all sportsbooks, adjusted for exchange commissions where applicable.
                                    </div>
                                </span>
                            </span>
                            <span class="detail-value best-odds" aria-label="Best available odds: {{ opportunity.best_available_odds }}">
                                {{ opportunity.best_available_odds }}
                            </span>
                        </div>

                        <!-- Expected Value - Moved to appear under Best Available Odds -->
                        <div class="detail-item ev-detail">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Expected Value:
                                    <button class="help-icon" aria-label="Expected Value Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        Expected Value (EV) is the percentage edge this bet has over fair odds. Positive EV means the bet is theoretically profitable long-term.
                                    </div>
                                </span>
                            </span>
                            <span class="detail-value ev-value {{ opportunity.ev_classification }}" 
                                  aria-label="Expected value: {{ opportunity.ev_percentage|round(1) }}%">
                                {{ opportunity.ev_percentage|round(1) }}%
                            </span>
                        </div>

                        <!-- Available Odds from All Sportsbooks -->
                        {% if opportunity.available_odds %}
                        <div class="detail-item available-odds-section">
                            <span class="detail-label">Available Odds:</span>
                            <div class="available-odds-list" role="list" aria-label="Sportsbook odds">
                                {% for odds_item in opportunity.available_odds %}
                                <span class="odds-item" role="listitem" 
                                      aria-label="{{ odds_item.bookmaker }}: {{ odds_item.odds }}">
                                    {{ odds_item.bookmaker }}: {{ odds_item.odds }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if admin_mode %}
                <!-- Admin Mode: Per-Card Debug Information -->
                <section class="card-debug-section">
                    <details class="card-debug">
                        <summary class="card-debug-summary">
                            <i class="fas fa-bug me-2"></i>Debug Information
                        </summary>
                        <div class="card-debug-content">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>EV Calculation Breakdown</h5>
                                    <div class="debug-calc">
                                        <strong>Fair Odds:</strong><br>
                                        &nbsp;&nbsp;American: {{ opportunity._debug.ev_breakdown.fair_odds.american }}<br>
                                        &nbsp;&nbsp;Decimal: {{ opportunity._debug.ev_breakdown.fair_odds.decimal }}<br>
                                        &nbsp;&nbsp;Implied Prob: {{ opportunity._debug.ev_breakdown.fair_odds.implied_probability }}%<br><br>
                                        
                                        <strong>Best Odds:</strong><br>
                                        &nbsp;&nbsp;American: {{ opportunity._debug.ev_breakdown.best_odds.american }}<br>
                                        &nbsp;&nbsp;Decimal: {{ opportunity._debug.ev_breakdown.best_odds.decimal }}<br>
                                        &nbsp;&nbsp;Implied Prob: {{ opportunity._debug.ev_breakdown.best_odds.implied_probability }}%<br><br>
                                        
                                        <strong>EV Formula:</strong><br>
                                        &nbsp;&nbsp;{{ opportunity._debug.ev_breakdown.ev_calculation.formula }}<br>
                                        &nbsp;&nbsp;= {{ opportunity._debug.ev_breakdown.ev_calculation.theoretical_ev }}<br>
                                        &nbsp;&nbsp;Actual EV: {{ opportunity._debug.ev_breakdown.ev_calculation.actual_ev_percentage }}%<br>
                                        &nbsp;&nbsp;Difference: {{ opportunity._debug.ev_breakdown.ev_calculation.difference }}<br><br>
                                        
                                        <strong>Classification:</strong><br>
                                        &nbsp;&nbsp;Tier: {{ opportunity._debug.ev_breakdown.classification.ev_tier }}<br>
                                        &nbsp;&nbsp;Logic: {{ opportunity._debug.ev_breakdown.classification.reasoning }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Data Sources & Transformations</h5>
                                    <div class="debug-sources">
                                        <strong>Sources:</strong><br>
                                        &nbsp;&nbsp;Best Odds: {{ opportunity._debug.data_sources.best_odds_source }}<br>
                                        &nbsp;&nbsp;Fair Odds: {{ opportunity._debug.data_sources.fair_odds_model }}<br>
                                        &nbsp;&nbsp;Exchange: {{ opportunity._debug.data_sources.posting_exchange }}<br><br>
                                        
                                        <strong>UI Transformation:</strong><br>
                                        &nbsp;&nbsp;Original Fields: {{ opportunity._debug.ui_transformations.original_keys|length }}<br>
                                        &nbsp;&nbsp;UI Fields: {{ opportunity._debug.ui_transformations.ui_keys|length }}<br>
                                        &nbsp;&nbsp;Classification: {{ opportunity._debug.ui_transformations.classification_logic }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h5>Raw Data Dump</h5>
                                <details class="raw-data-dump">
                                    <summary>Show Original Data Structure</summary>
                                    <pre class="raw-data"><code>{{ opportunity._original | tojson(indent=2) }}</code></pre>
                                </details>
                                
                                <h5 class="mt-3">UI Data Structure</h5>
                                <details class="ui-data-dump">
                                    <summary>Show UI-Transformed Data</summary>
                                    <pre class="ui-data"><code>{{ opportunity._debug.ui_data_structure | tojson(indent=2) }}</code></pre>
                                </details>
                            </div>
                        </div>
                    </details>
                </section>
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</main>

<script>
// Auto-submit filters on change (progressive enhancement)
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filters-form');
    const sportSelect = document.getElementById('sport-filter');
    const marketSelect = document.getElementById('market-filter');
    const clearButton = document.getElementById('clear-filters');
    const clearButtonEmpty = document.getElementById('clear-filters-empty');
    
    // Auto-submit on select change
    function autoSubmit() {
        form.submit();
    }
    
    if (sportSelect) {
        sportSelect.addEventListener('change', autoSubmit);
    }
    
    if (marketSelect) {
        marketSelect.addEventListener('change', autoSubmit);
    }
    
    // Clear filters functionality
    function clearFilters() {
        if (sportSelect) sportSelect.value = '';
        if (marketSelect) marketSelect.value = '';
        form.submit();
    }
    
    if (clearButton) {
        clearButton.addEventListener('click', clearFilters);
    }
    
    if (clearButtonEmpty) {
        clearButtonEmpty.addEventListener('click', clearFilters);
    }
});

// Real-time updates functionality
let wsConnection = null;
let sseConnection = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function showUpdateNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('realtime-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'realtime-notification';
        notification.className = 'alert alert-dismissible fade show';
        notification.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1050; min-width: 300px;';
        document.body.appendChild(notification);
    }
    
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        <i class="fas fa-broadcast-tower me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Auto-hide after 5 seconds for info messages
    if (type === 'info') {
        setTimeout(() => {
            if (notification) {
                notification.remove();
            }
        }, 5000);
    }
}

function showLoadingSpinner() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) {
        spinner.classList.remove('d-none');
    }
}

function hideLoadingSpinner() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) {
        spinner.classList.add('d-none');
    }
}

function updateTableWithNewData(data) {
    try {
        // Hide loading spinner since we got data
        hideLoadingSpinner();
        
        if (data.type === 'ev_update' && data.opportunities) {
            // Show update notification
            showUpdateNotification(
                `Updated with ${data.summary.total_count} opportunities (${data.summary.positive_ev_count} positive EV)`,
                'success'
            );
            
            // For now, we'll just show a notification
            // Full table replacement would require more complex implementation
            // that maintains user state (filters, etc.)
            
            // Optional: Auto-refresh the page to show new data
            // setTimeout(() => window.location.reload(), 2000);
        }
    } catch (error) {
        console.error('Error updating table:', error);
        showUpdateNotification('Error processing update', 'warning');
    }
}

function connectWebSocket() {
    try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/ev`;
        
        wsConnection = new WebSocket(wsUrl);
        
        wsConnection.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            showUpdateNotification('Real-time updates connected', 'success');
        };
        
        wsConnection.onmessage = function(event) {
            console.log('WebSocket message received');
            const data = JSON.parse(event.data);
            updateTableWithNewData(data);
        };
        
        wsConnection.onclose = function() {
            console.log('WebSocket disconnected');
            wsConnection = null;
            showUpdateNotification('Real-time connection lost, switching to fallback...', 'warning');
            
            // Fallback to SSE
            setTimeout(connectSSE, 1000);
        };
        
        wsConnection.onerror = function(error) {
            console.error('WebSocket error:', error);
            showUpdateNotification('WebSocket connection failed', 'warning');
        };
        
    } catch (error) {
        console.error('Failed to create WebSocket connection:', error);
        connectSSE();
    }
}

function connectSSE() {
    try {
        if (sseConnection) {
            sseConnection.close();
        }
        
        sseConnection = new EventSource('/sse/ev');
        
        sseConnection.onopen = function() {
            console.log('SSE connected');
            showUpdateNotification('Real-time updates connected (SSE)', 'info');
        };
        
        sseConnection.onmessage = function(event) {
            console.log('SSE message received');
            const data = JSON.parse(event.data);
            
            // Skip connection confirmation messages
            if (data.type === 'connection') {
                return;
            }
            
            updateTableWithNewData(data);
        };
        
        sseConnection.onerror = function(error) {
            console.error('SSE error:', error);
            sseConnection.close();
            sseConnection = null;
            
            // Retry with exponential backoff
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.pow(2, reconnectAttempts) * 1000;
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectWebSocket, delay);
            } else {
                showUpdateNotification('Real-time updates unavailable', 'warning');
            }
        };
        
    } catch (error) {
        console.error('Failed to create SSE connection:', error);
        showUpdateNotification('Real-time updates unavailable', 'warning');
    }
}

// Initialize real-time connection when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only connect if we're on a page with opportunities
    const opportunitiesContainer = document.querySelector('.cards-grid');
    if (opportunitiesContainer) {
        console.log('Initializing real-time updates...');
        connectWebSocket();
    }
    
    // Cleanup connections when page unloads
    window.addEventListener('beforeunload', function() {
        if (wsConnection) {
            wsConnection.close();
        }
        if (sseConnection) {
            sseConnection.close();
        }
    });
});
</script>
{% endblock %} 