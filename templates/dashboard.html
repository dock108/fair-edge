{% extends "base.html" %}

{% block title %}Sports Betting Dashboard - Live Expected Value Analysis{% endblock %}

{% block head %}
<meta name="description" content="Educational sports betting analysis tool for research and comparison of odds across multiple sportsbooks. For educational purposes only.">
<meta name="keywords" content="sports betting, odds comparison, betting analysis, EV calculator, educational tool">
{% endblock %}

{% block content %}
<!-- Skip Link for Accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

{% if admin_mode %}
<!-- Debug Mode Indicator -->
<div class="debug-mode-indicator" role="status" aria-live="polite">
    üêõ DEBUG MODE ACTIVE
</div>
{% endif %}

{% if admin_mode %}
<!-- Admin Mode Debug Panel -->
<div class="admin-debug-panel">
    <div class="container-fluid">
        <div class="debug-header">
            <h2><i class="fas fa-cog me-2"></i>Developer Debug Mode</h2>
            <p class="text-muted">This panel is only visible to administrators and contains diagnostic information.</p>
        </div>
        
        <details class="debug-section">
            <summary class="debug-summary">
                <i class="fas fa-chart-line me-2"></i>System Metrics & Performance
            </summary>
            <div class="debug-content">
                <div class="row">
                    <div class="col-md-6">
                        <h4>System Information</h4>
                        <div class="debug-data">
                            <strong>App Version:</strong> {{ debug_info.system_metrics.app_version }}<br>
                            <strong>Environment:</strong> {{ debug_info.system_metrics.environment }}<br>
                            <strong>Python Version:</strong> {{ debug_info.system_metrics.python_version }}<br>
                            <strong>Debug Mode:</strong> {{ debug_info.system_metrics.debug_mode }}<br>
                            <strong>Timestamp:</strong> {{ debug_info.system_metrics.timestamp }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Performance Metrics</h4>
                        <div class="debug-data">
                            <strong>Page Generation:</strong> {{ debug_info.performance.page_generation_time_ms }}ms<br>
                            <strong>Data Cached:</strong> {{ debug_info.performance.data_fetch_cached }}<br>
                            <strong>Processing Time:</strong> {{ debug_info.performance.total_processing_time }}<br>
                            <strong>Memory Efficient:</strong> {{ debug_info.performance.memory_efficient }}
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details class="debug-section">
            <summary class="debug-summary">
                <i class="fas fa-database me-2"></i>Data Pipeline Summary
            </summary>
            <div class="debug-content">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Data Flow</h4>
                        <div class="debug-data">
                            <strong>Raw Events:</strong> {{ debug_info.data_summary.raw_events }}<br>
                            <strong>Processed Opportunities:</strong> {{ debug_info.data_summary.processed_opportunities }}<br>
                            <strong>UI Opportunities:</strong> {{ debug_info.data_summary.ui_opportunities }}<br>
                            <strong>Processing Time:</strong> {{ debug_info.data_summary.data_processing_time }}s
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h4>EV Distribution</h4>
                        <div class="debug-data">
                            <strong>Excellent (4.5%+):</strong> {{ debug_info.ev_distribution.excellent_count }}<br>
                            <strong>High (2.5%+):</strong> {{ debug_info.ev_distribution.high_count }}<br>
                            <strong>Positive:</strong> {{ debug_info.ev_distribution.positive_count }}<br>
                            <strong>Neutral/Negative:</strong> {{ debug_info.ev_distribution.neutral_negative_count }}<br>
                            <strong>Max EV:</strong> {{ debug_info.ev_distribution.max_ev|round(2) }}%<br>
                            <strong>Min EV:</strong> {{ debug_info.ev_distribution.min_ev|round(2) }}%<br>
                            <strong>Avg EV:</strong> {{ debug_info.ev_distribution.avg_ev|round(2) }}%
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h4>Filter State</h4>
                        <div class="debug-data">
                            <strong>Sport Filter:</strong> {{ debug_info.filter_state.sport_filter }}<br>
                            <strong>Market Filter:</strong> {{ debug_info.filter_state.market_filter }}<br>
                            <strong>Active Filters:</strong> {{ debug_info.filter_state.active_filters }}<br>
                            <strong>Cache Status:</strong> {{ debug_info.data_summary.cache_status }}
                        </div>
                    </div>
                </div>
            </div>
        </details>
    </div>
</div>
{% endif %}

<!-- ‚ñ∏ Hero Banner  -->
<section class="hero-ev">
  <div class="hero-ev__content container">
    <h1 class="hero-ev__title">
      <span class="icon">&#xf522;</span>  <!-- remove if you don't use FontAwesome -->
      Sports Betting <strong>+EV</strong> Analyzer
    </h1>
    <p class="hero-ev__tagline">
      Educational odds analysis and comparison tool
    </p>
    <p class="hero-ev__subtag">
      For research and educational purposes only
    </p>
  </div>
  <svg class="hero-ev__wave" viewBox="0 0 1440 60" aria-hidden="true">
    <path d="M0,30 C240,60 480,0 720,30 C960,60 1200,0 1440,30 L1440,60 L0,60 Z" fill="#fff"/>
  </svg>
</section>

<!-- Metrics Section -->
<section class="metrics-section" role="region" aria-labelledby="metrics-heading">
    <div class="container-fluid">
        <h2 id="metrics-heading" class="sr-only">Dashboard Metrics</h2>
        {% if filter_applied %}
        <div class="text-center mb-3" role="status" aria-live="polite">
            <span class="badge bg-info fs-6">
                <i class="fas fa-filter me-1" aria-hidden="true"></i>
                <span class="sr-only">Filters are active:</span>
                Filters Active
                {% if current_sport and current_sport != '' %} - Sport: {{ current_sport|title }}{% endif %}
                {% if current_market and current_market != '' %} - Market: {{ current_market|title }}{% endif %}
            </span>
        </div>
        {% endif %}
        <div class="row g-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="total-desc">{{ analytics.total_opportunities }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Total Opportunities
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Total number of betting opportunities found across all analyzed markets and sportsbooks
                            </div>
                        </span>
                    </div>
                    <div id="total-desc" class="sr-only">Total betting opportunities available</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="positive-desc">{{ analytics.positive_ev_count }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Positive EV Bets
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Bets with positive expected value - theoretically profitable opportunities based on our fair odds model
                            </div>
                        </span>
                    </div>
                    <div id="positive-desc" class="sr-only">Number of bets with positive expected value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="high-desc">{{ analytics.high_ev_count }}</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            High EV (4.5%+)
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                Premium opportunities with 4.5% or higher expected value - our strongest betting recommendations
                            </div>
                        </span>
                    </div>
                    <div id="high-desc" class="sr-only">High expected value opportunities with 4.5% or greater edge</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <span class="metric-value" aria-describedby="max-desc">{{ analytics.max_ev_percentage }}%</span>
                    <div class="metric-label">
                        <span class="tooltip-container">
                            Max EV Found
                            <button class="help-icon" aria-label="Help" type="button" tabindex="0">?</button>
                            <div class="tooltip tooltip-large" role="tooltip">
                                The highest expected value percentage found among all current opportunities
                            </div>
                        </span>
                    </div>
                    <div id="max-desc" class="sr-only">Maximum expected value percentage found</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced Free Tier Upgrade Banner -->
{% if user_role == 'free' and role_metadata.truncated %}
<div class="container-fluid mt-3">
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <strong><i class="fas fa-star me-1"></i>Upgrade to Premium ‚Üí</strong> 
        You're seeing main lines only (moneyline, spreads, totals). 
        <strong>Upgrade to unlock props, alt lines, and live markets.</strong>
        <a href="/pricing" class="alert-link">See plans</a>.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close upgrade banner"></button>
                    </div>
</div>
{% endif %}

<!-- Filter Controls Section -->
<section class="filters-section" role="region" aria-labelledby="filters-heading">
    <div class="filters-container">
        <h2 id="filters-heading" class="sr-only">Filter Controls</h2>
        
        <!-- Client-Side Filters -->
        <div class="client-filters mb-3">
            <div class="row g-3">
                    <div class="col-md-6">
                    <!-- Search Box with Icon -->
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </span>
                        <input id="filter-search" 
                               class="form-control" 
                               placeholder="Search teams, events, players..."
                               aria-label="Search betting opportunities"
                               type="text">
                        <button class="btn btn-outline-secondary" 
                                type="button" 
                                id="clear-search"
                                aria-label="Clear search">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="form-text">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Try "Lakers", "Over", or player names
                        </small>
                </div>
            </div>
                
                <div class="col-md-3">
                    <!-- Sport Filter -->
                    <select id="sport-filter" class="form-select" aria-label="Filter by sport">
                        <option value="">All Sports</option>
                        {% for sport in sports_supported %}
                        <option value="{{ sport }}">
                            {% if sport == 'americanfootball_nfl' %}NFL Football
                            {% elif sport == 'basketball_nba' %}NBA Basketball  
                            {% elif sport == 'baseball_mlb' %}MLB Baseball
                            {% elif sport == 'icehockey_nhl' %}NHL Hockey
                            {% else %}{{ sport|title }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
            </div>
                
                <div class="col-md-3">
                    <!-- EV Filter -->
                    <select id="ev-filter" class="form-select" aria-label="Filter by expected value">
                        <option value="">All EV</option>
                        <option value="high">High EV (4.5%+)</option>
                        <option value="positive">Positive EV (0%+)</option>
                    </select>
        </div>
    </div>
            
            <!-- Filter Status & Clear -->
            <div class="filter-status mt-2 d-flex justify-content-between align-items-center">
                <div class="filter-spinner d-none">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Filtering...</span>
</div>
                    <small class="text-muted">Updating results...</small>
                </div>
                <div class="filter-results-count">
                    <small class="text-muted" id="results-count"></small>
                </div>
                <button class="btn btn-sm btn-outline-secondary d-none" 
                        id="clear-all-filters" 
                        type="button">
                    <i class="fas fa-times me-1"></i>
                    Clear All Filters
                </button>
            </div>
        </div>
        
        <!-- Server-Side Filters (Legacy/Fallback) -->
        <details class="server-filters mt-3">
            <summary class="text-muted small">
                <i class="fas fa-cog me-1"></i>
                Advanced Server Filters (for bookmarking)
            </summary>
            <form class="filters-form mt-2" method="get" role="search" aria-label="Server-side filter betting opportunities">
            <div class="filter-row">
                <div class="filter-group">
                        <label for="sport-filter-server" class="filter-label">Sport:</label>
                        <select name="sport" id="sport-filter-server" class="filter-select" aria-describedby="sport-help">
                        <option value="">All Sports</option>
                        <option value="basketball_nba" {% if current_sport == 'basketball_nba' %}selected{% endif %}>NBA Basketball</option>
                        <option value="americanfootball_nfl" {% if current_sport == 'americanfootball_nfl' %}selected{% endif %}>NFL Football</option>
                        <option value="baseball_mlb" {% if current_sport == 'baseball_mlb' %}selected{% endif %}>MLB Baseball</option>
                        <option value="icehockey_nhl" {% if current_sport == 'icehockey_nhl' %}selected{% endif %}>NHL Hockey</option>
                    </select>
                    <div id="sport-help" class="sr-only">Filter opportunities by specific sport or league</div>
                </div>
                
                <div class="filter-group">
                        <label for="market-filter-server" class="filter-label">Market:</label>
                        <select name="market" id="market-filter-server" class="filter-select" aria-describedby="market-help">
                        <option value="">All Markets</option>
                        <option value="h2h" {% if current_market == 'h2h' %}selected{% endif %}>Moneyline</option>
                        <option value="spreads" {% if current_market == 'spreads' %}selected{% endif %}>Point Spread</option>
                        <option value="totals" {% if current_market == 'totals' %}selected{% endif %}>Over/Under Totals</option>
                        <option value="player_props" {% if current_market == 'player_props' %}selected{% endif %}>Player Props</option>
                    </select>
                    <div id="market-help" class="sr-only">Filter opportunities by betting market type</div>
                </div>
                
                <div class="filter-group filter-actions">
                    <button type="submit" class="filter-btn filter-btn-apply btn-primary" aria-describedby="apply-help">
                        <i class="fas fa-search me-1" aria-hidden="true"></i>
                        Apply Filters
                    </button>
                    <a href="/" class="filter-btn filter-btn-clear btn-secondary" aria-describedby="clear-help">
                        <i class="fas fa-times me-1" aria-hidden="true"></i>
                        Clear Filters
                    </a>
                    <div id="apply-help" class="sr-only">Apply selected filters to update results</div>
                    <div id="clear-help" class="sr-only">Remove all filters and show all opportunities</div>
                </div>
            </div>
        </form>
        </details>
    </div>
</section>

<!-- Betting Opportunities Section -->
<main class="opportunities-section" id="main-content" role="main" aria-labelledby="opportunities-heading">
    <div class="main-container">
        <h2 id="opportunities-heading" class="sr-only">Betting Opportunities</h2>
        
        <!-- Enhanced Loading Spinner -->
        <div id="table-spinner" class="d-flex justify-content-center my-3 d-none">
            <div class="spinner-border text-primary me-2" role="status" aria-hidden="true"></div>
            <span class="text-muted">Loading opportunities...</span>
            <span class="visually-hidden">Loading...</span>
        </div>
        
        {% if error %}
        <!-- Error State -->
        <div class="empty-state" role="alert" aria-live="assertive">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning" aria-hidden="true"></i>
            <h3>Unable to Load Data</h3>
            <p>{{ error }}</p>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-refresh me-1" aria-hidden="true"></i>
                Try Again
            </a>
        </div>
        
        {% elif opportunities|length == 0 %}
        <!-- Empty State -->
        <div class="empty-state" role="status" aria-live="polite">
            <i class="fas fa-search fa-3x mb-3 text-muted" aria-hidden="true"></i>
            <h3>No Opportunities Found</h3>
            <p>{% if filter_applied %}No betting opportunities match your current filters. Try adjusting your search criteria or clearing filters to see all available opportunities.{% else %}No betting opportunities are currently available. Please check back later.{% endif %}</p>
            {% if filter_applied %}
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-times me-1" aria-hidden="true"></i>
                Clear All Filters
            </a>
            {% endif %}
        </div>
        
        {% else %}
        <!-- Results Summary for Screen Readers -->
        <div class="sr-only" aria-live="polite" role="status">
            Showing {{ opportunities|length }} betting opportunities
            {% if filter_applied %}
                {% if current_sport %} for {{ current_sport|title }}{% endif %}
                {% if current_market %} in {{ current_market|title }} markets{% endif %}
            {% endif %}
        </div>
        
        <!-- Opportunities Grid -->
        <div class="cards-grid" role="list" aria-label="Betting opportunities">
            <!-- Opportunities will be loaded here by JavaScript -->
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading opportunities...</span>
                </div>
                <p class="mt-2 text-muted">Loading betting opportunities...</p>
            </div>
        </div>
        {% endif %}
    </div>
</main>

<script>
// ===========================
// ENHANCED BOOTSTRAP 5 HELPERS
// ===========================

// Compact debounce helper (MDN pattern)
const debounce = (fn, d = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d) } };

// Enhanced spinner control for Bootstrap 5
function showSpinner(state = true) {
    const spinner = document.getElementById("table-spinner");
    if (spinner) {
        spinner.classList.toggle("d-none", !state);
    }
}

function hideSpinner() {
    showSpinner(false);
}

// Show/hide filter spinner
function showFilterSpinner() {
    if (filterSpinner) {
        filterSpinner.classList.remove('d-none');
    }
}

function hideFilterSpinner() {
    if (filterSpinner) {
        filterSpinner.classList.add('d-none');
    }
}

// ===========================
// DEBOUNCED CLIENT-SIDE FILTERING
// ===========================

// Filter state
let currentFilters = {
    search: '',
    sport: '',
    ev: ''
};

let originalOpportunities = []; // Store original data
let isFiltering = false;

// DOM elements
const searchBox = document.getElementById('filter-search');
    const sportSelect = document.getElementById('sport-filter');
const evSelect = document.getElementById('ev-filter');
const clearSearchBtn = document.getElementById('clear-search');
const clearAllBtn = document.getElementById('clear-all-filters');
const resultsCount = document.getElementById('results-count');
const filterSpinner = document.querySelector('.filter-spinner');

// Create debounced filter function
const debouncedFilter = debounce(() => {
    applyClientSideFilters();
}, 300);
    
// Update results count
function updateResultsCount(count, total) {
    if (resultsCount) {
        if (count === total) {
            resultsCount.textContent = `Showing all ${total} opportunities`;
        } else {
            resultsCount.textContent = `Showing ${count} of ${total} opportunities`;
        }
    }
}

// Show/hide clear all button
function updateClearAllButton() {
    const hasFilters = currentFilters.search || currentFilters.sport || currentFilters.ev;
    if (clearAllBtn) {
        clearAllBtn.classList.toggle('d-none', !hasFilters);
    }
}

// Apply client-side filters to the current data
function applyClientSideFilters() {
    if (originalOpportunities.length === 0) return;
    
    showFilterSpinner();
    
    let filtered = [...originalOpportunities];
    
    // Search filter
    if (currentFilters.search) {
        const searchTerm = currentFilters.search.toLowerCase();
        filtered = filtered.filter(opp => {
            return (
                opp.event.toLowerCase().includes(searchTerm) ||
                opp.bet_description.toLowerCase().includes(searchTerm) ||
                opp.bet_type.toLowerCase().includes(searchTerm) ||
                (opp.best_odds_source && opp.best_odds_source.toLowerCase().includes(searchTerm))
            );
        });
    }
    
    // Sport filter
    if (currentFilters.sport) {
        filtered = filtered.filter(opp => {
            // This would need sport info in the opportunity data
            // For now, we'll do a basic text match
            return opp.event.toLowerCase().includes(currentFilters.sport.toLowerCase());
        });
    }
    
    // EV filter
    if (currentFilters.ev) {
        if (currentFilters.ev === 'high') {
            filtered = filtered.filter(opp => opp.ev_percentage >= 4.5);
        } else if (currentFilters.ev === 'positive') {
            filtered = filtered.filter(opp => opp.ev_percentage > 0);
        }
    }
    
    // Render filtered results
    renderOpportunities(filtered);
    updateResultsCount(filtered.length, originalOpportunities.length);
    updateClearAllButton();
    
    hideFilterSpinner();
}

// Fetch fresh data from API with server-side filters
async function fetchFilteredData() {
    try {
        showFilterSpinner();
        
        const params = new URLSearchParams();
        if (currentFilters.search.trim()) {
            params.set("search", currentFilters.search.trim());
    }
        if (currentFilters.sport) {
            params.set("sport", currentFilters.sport);
        }
        
        const url = "/api/opportunities?" + params.toString();
        const response = await fetch(url, { 
            credentials: "include",
            headers: {
                'Cache-Control': 'no-store'
            }
        });
        
        if (!response.ok) {
            console.error('Filter request failed:', await response.text());
            hideFilterSpinner();
            return;
        }
        
        const data = await response.json();
        
        // Update original data and apply client-side filters
        originalOpportunities = data.opportunities || [];
        applyClientSideFilters();
        
    } catch (error) {
        console.error('Error fetching filtered data:', error);
        hideFilterSpinner();
    }
}

// Render opportunities in the DOM
function renderOpportunities(opportunities) {
    const cardsGrid = document.querySelector('.cards-grid');
    if (!cardsGrid) return;
    
    if (opportunities.length === 0) {
        cardsGrid.innerHTML = `
            <div class="col-12">
                <div class="empty-state text-center py-5">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <h3>No matches found</h3>
                    <p class="text-muted">Try adjusting your search terms or filters</p>
                    <button class="btn btn-outline-primary" onclick="clearAllFilters()">
                        <i class="fas fa-times me-1"></i>
                        Clear Filters
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    // For now, we'll show a simple list. In production, you'd want to 
    // recreate the full card HTML structure here
    cardsGrid.innerHTML = opportunities.map((opp, index) => `
        <article class="odds-card ev-${opp.ev_classification}" role="listitem" 
                 aria-labelledby="card-${index}-title"
                 aria-describedby="card-${index}-recommended">
                
                <!-- Card Header -->
                <header class="odds-card__header">
                <h2 class="odds-card__title" id="card-${index}-title">${opp.event}</h2>
                <p class="odds-card__subtitle">${opp.bet_description}</p>
                </header>

                <!-- Card Body with Recommended Odds as Focal Point -->
                <div class="odds-card__body">
                    <!-- Recommended Posting Odds - PRIMARY FOCAL POINT -->
                ${opp.recommended_posting_odds && opp.recommended_posting_odds !== 'N/A' ? `
                <div class="odds-card__recommended" id="card-${index}-recommended">
                        <span class="recommended-label">
                            <span class="tooltip-container">
                                Recommended Posting Odds:
                                <button class="help-icon" aria-label="Posting Odds Help" type="button" tabindex="0">?</button>
                                <div class="tooltip tooltip-large" role="tooltip">
                                    Recommended odds to post on betting exchanges to achieve at least 2.5% expected value after commission fees.
                                </div>
                            </span>
                        </span>
                    <span class="recommended-value" aria-label="Recommended posting odds: ${opp.recommended_posting_odds}">
                        ${opp.recommended_posting_odds}
                        </span>
                        
                        <!-- Action Buttons under Recommended Odds -->
                    ${opp.action_link ? `
                        <div class="action-buttons" role="group" aria-label="Betting actions">
                        <a href="${opp.action_link}" 
                                           class="odds-card__action-btn post" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           aria-label="Post bet - opens in new window">
                                            <i class="fas fa-plus me-1" aria-hidden="true"></i>
                                            Post Bet
                                        </a>
                        </div>
                    ` : ''}
                    </div>
                ` : ''}

                    <!-- Other Odds Details - Secondary Information -->
                    <div class="odds-card__details">
                        <!-- Fair Odds -->
                        <div class="detail-item">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Fair Odds:
                                    <button class="help-icon" aria-label="Fair Odds Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        The true odds calculated by our model. If available odds are better than this, the bet has positive expected value.
                                    </div>
                                </span>
                            </span>
                        <span class="detail-value" aria-label="Fair odds: ${opp.fair_odds}">
                            ${opp.fair_odds}
                            </span>
                        </div>

                        <!-- Best Available Odds -->
                        <div class="detail-item">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Best Available:
                                    <button class="help-icon" aria-label="Best Odds Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        The best odds currently available across all sportsbooks, adjusted for exchange commissions where applicable.
                                    </div>
                                </span>
                            </span>
                        <span class="detail-value best-odds" aria-label="Best available odds: ${opp.best_available_odds}">
                            ${opp.best_available_odds}
                            </span>
                        </div>

                        <!-- Expected Value - Moved to appear under Best Available Odds -->
                        <div class="detail-item ev-detail">
                            <span class="detail-label">
                                <span class="tooltip-container">
                                    Expected Value:
                                    <button class="help-icon" aria-label="Expected Value Help" type="button" tabindex="0">?</button>
                                    <div class="tooltip tooltip-large" role="tooltip">
                                        Expected Value (EV) is the percentage edge this bet has over fair odds. Positive EV means the bet is theoretically profitable long-term.
                                    </div>
                                </span>
                            </span>
                        <span class="detail-value ev-value ${opp.ev_classification}" 
                              aria-label="Expected value: ${opp.ev_percentage.toFixed(1)}%">
                            ${opp.ev_percentage.toFixed(1)}%
                            </span>
                        </div>

                        <!-- Available Odds from All Sportsbooks -->
                    ${opp.available_odds && opp.available_odds.length > 0 ? `
                        <div class="detail-item available-odds-section">
                            <span class="detail-label">Available Odds:</span>
                            <div class="available-odds-list" role="list" aria-label="Sportsbook odds">
                            ${opp.available_odds.map(odds_item => `
                                <span class="odds-item" role="listitem" 
                                  aria-label="${odds_item.bookmaker}: ${odds_item.odds}">
                                ${odds_item.bookmaker}: ${odds_item.odds}
                                </span>
                            `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    </div>
                </div>
        </article>
    `).join('');
}

// Clear all filters
function clearAllFilters() {
    currentFilters = { search: '', sport: '', ev: '' };
    
    if (searchBox) searchBox.value = '';
        if (sportSelect) sportSelect.value = '';
    if (evSelect) evSelect.value = '';
    
    updateClearAllButton();
    applyClientSideFilters();
}

// Clear search only
function clearSearch() {
    currentFilters.search = '';
    if (searchBox) searchBox.value = '';
    updateClearAllButton();
    applyClientSideFilters();
}

// Initialize client-side filtering
function initializeFiltering() {
    if (!searchBox || !sportSelect || !evSelect) return;
    
    // Store original opportunities data
    const cardsGrid = document.querySelector('.cards-grid');
    if (cardsGrid) {
        // Extract data from existing cards (simplified for now)
        // In production, you'd want to get this from the template context or API
        originalOpportunities = window.opportunitiesData || [];
    }
    
    // Event listeners
    searchBox.addEventListener('input', debounce((e) => {
        currentFilters.search = e.target.value;
        applyClientSideFilters();
    }, 300));
    
    sportSelect.addEventListener('change', debounce((e) => {
        currentFilters.sport = e.target.value;
        applyClientSideFilters();
    }, 300));
    
    evSelect.addEventListener('change', debounce((e) => {
        currentFilters.ev = e.target.value;
        applyClientSideFilters();
    }, 300));
    
    // Clear buttons
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearch);
    }
    
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
    }
    
    // Keyboard shortcuts
    searchBox.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            clearSearch();
        }
    });
    
    // Event listeners for server-side form (legacy support)
    const serverSportSelect = document.getElementById('sport-filter-server');
    const serverMarketSelect = document.getElementById('market-filter-server');
    
    if (serverSportSelect) {
        serverSportSelect.addEventListener('change', debounce(() => {
            serverSportSelect.closest('form').submit();
        }, 300));
    }
    
    if (serverMarketSelect) {
        serverMarketSelect.addEventListener('change', debounce(() => {
            serverMarketSelect.closest('form').submit();
        }, 300));
    }
    
    console.log('‚úÖ Client-side filtering initialized');
}

// ===========================
// REAL-TIME UPDATES (EXISTING)
// ===========================

// Real-time updates functionality
let wsConnection = null;
let sseConnection = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
let lastUpdateTime = null;
let hasReceivedFirstUpdate = false;

function showUpdateNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('realtime-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'realtime-notification';
        notification.className = 'alert alert-dismissible fade show';
        notification.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1050; min-width: 300px;';
        document.body.appendChild(notification);
    }
    
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        <i class="fas fa-broadcast-tower me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Auto-hide after 5 seconds for info messages
    if (type === 'info') {
        setTimeout(() => {
            if (notification) {
                notification.remove();
            }
        }, 5000);
    }
}

function showLoadingSpinner() {
    showSpinner(true);
}

function hideLoadingSpinner() {
    showSpinner(false);
}

function formatTimeSince(isoTimestamp) {
    try {
        const updateTime = new Date(isoTimestamp);
        const now = new Date();
        const diffMs = now - updateTime;
        const diffSeconds = Math.floor(diffMs / 1000);
        
        if (diffSeconds < 5) {
            return 'just now';
        } else if (diffSeconds < 60) {
            return `${diffSeconds}s ago`;
        } else if (diffSeconds < 3600) {
            const minutes = Math.floor(diffSeconds / 60);
            return `${minutes}m ago`;
        } else {
            const hours = Math.floor(diffSeconds / 3600);
            return `${hours}h ago`;
        }
    } catch (error) {
        return 'recently';
    }
}

function updateTimestampDisplay() {
    if (lastUpdateTime) {
        const timestampDisplay = document.getElementById('last-update-display');
        if (timestampDisplay) {
            timestampDisplay.innerHTML = `<i class="fas fa-clock me-1"></i>Updated ${formatTimeSince(lastUpdateTime)}`;
        }
    }
}

function createTimestampDisplay() {
    // Create timestamp display element if it doesn't exist
    let timestampDisplay = document.getElementById('last-update-display');
    if (!timestampDisplay) {
        timestampDisplay = document.createElement('div');
        timestampDisplay.id = 'last-update-display';
        timestampDisplay.className = 'text-muted small text-center mb-3';
        timestampDisplay.innerHTML = '<i class="fas fa-clock me-1"></i><span>Connecting...</span>';
        
        // Insert after the enhanced spinner
        const spinner = document.getElementById('table-spinner');
        if (spinner && spinner.parentNode) {
            spinner.parentNode.insertBefore(timestampDisplay, spinner.nextSibling);
        }
    }
    return timestampDisplay;
}

// Helper functions for parsing backend data
function extractActionLink(linksStr) {
    if (!linksStr || linksStr === 'N/A') return null;
    
    // Parse "Post:https://novig.com/exchange" format
    const links = linksStr.split('|');
    for (const link of links) {
        if (link.trim()) {
            const linkParts = link.trim().split(':');
            if (linkParts.length >= 2 && linkParts[0].trim() === 'Post') {
                return linkParts.slice(1).join(':').trim();
            }
        }
    }
    return null;
}

function parseAvailableOdds(allOddsStr) {
    if (!allOddsStr || allOddsStr === 'N/A') return [];
    
    // Parse "DraftKings: +110; FanDuel: +105; ..." format
    const available_odds = [];
    const odds_parts = allOddsStr.split('; ');
    for (const part of odds_parts) {
        if (part.includes(':')) {
            const [bookmaker, odds] = part.split(':', 2);
            available_odds.push({
                bookmaker: bookmaker.trim(),
                odds: odds.trim()
            });
        }
    }
    
    // Sort odds from best to worst
    return available_odds.sort((a, b) => {
        try {
            const oddsA = parseInt(a.odds.replace('+', ''));
            const oddsB = parseInt(b.odds.replace('+', ''));
            
            if (oddsA > 0 && oddsB > 0) {
                return oddsB - oddsA; // Higher positive is better
            } else if (oddsA < 0 && oddsB < 0) {
                return oddsA - oddsB; // Less negative is better
            } else if (oddsA > 0 && oddsB < 0) {
                return -1; // Positive odds are better than negative
            } else {
                return 1; // Negative odds are worse than positive
            }
        } catch (error) {
            return 0; // Keep original order if parsing fails
        }
    });
}

// Update analytics metrics in the UI
function updateAnalyticsDisplay(opportunities) {
    if (!opportunities || opportunities.length === 0) return;
    
    // Calculate analytics from current opportunities
    const totalCount = opportunities.length;
    const positiveEvCount = opportunities.filter(opp => opp.ev_percentage > 0).length;
    const highEvCount = opportunities.filter(opp => opp.ev_percentage >= 4.5).length;
    const maxEv = Math.max(...opportunities.map(opp => opp.ev_percentage), 0);
    
    // Update the metric cards
    const totalElement = document.querySelector('.metric-card .metric-value[aria-describedby="total-desc"]');
    if (totalElement) {
        totalElement.textContent = totalCount;
    }
    
    const positiveElement = document.querySelector('.metric-card .metric-value[aria-describedby="positive-desc"]');
    if (positiveElement) {
        positiveElement.textContent = positiveEvCount;
    }
    
    const highElement = document.querySelector('.metric-card .metric-value[aria-describedby="high-desc"]');
    if (highElement) {
        highElement.textContent = highEvCount;
    }
    
    const maxElement = document.querySelector('.metric-card .metric-value[aria-describedby="max-desc"]');
    if (maxElement) {
        maxElement.textContent = `${maxEv.toFixed(1)}%`;
    }
    
    console.log(`üìä Updated analytics: ${totalCount} total, ${positiveEvCount} positive EV, ${highEvCount} high EV, ${maxEv.toFixed(1)}% max`);
}

// Load initial data from server
async function loadInitialData() {
    try {
        console.log('Loading initial opportunities data...');
        
        const response = await fetch('/api/opportunities', {
            credentials: 'include',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            // Store the original data
            originalOpportunities = data.opportunities;
            
            // Render initial opportunities
            renderOpportunities(originalOpportunities);
            
            // Update results count
            updateResultsCount(originalOpportunities.length, originalOpportunities.length);
            
            // Update analytics metrics
            updateAnalyticsDisplay(originalOpportunities);
            
            console.log(`‚úÖ Loaded ${originalOpportunities.length} initial opportunities`);
        } else {
            // Show empty state
            const cardsGrid = document.querySelector('.cards-grid');
            if (cardsGrid) {
                cardsGrid.innerHTML = `
                    <div class="empty-state text-center py-5">
                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                        <h3>No Opportunities Available</h3>
                        <p class="text-muted">No betting opportunities are currently available. Please check back later.</p>
                                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        
        // Show error state
        const cardsGrid = document.querySelector('.cards-grid');
        if (cardsGrid) {
            cardsGrid.innerHTML = `
                <div class="empty-state text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                    <h3>Unable to Load Data</h3>
                    <p class="text-muted">Failed to load betting opportunities: ${error.message}</p>
                    <button class="btn btn-primary" onclick="loadInitialData()">
                        <i class="fas fa-refresh me-1"></i>
                        Try Again
                    </button>
                            </div>
            `;
        }
    }
}

function updateTableWithNewData(data) {
    try {
        // Hide loading spinner on first update
        if (!hasReceivedFirstUpdate) {
            hideLoadingSpinner();
            hasReceivedFirstUpdate = true;
        }
        
        if (data.type === 'ev_update') {
            // Update last update time
            if (data.updated_at) {
                lastUpdateTime = data.updated_at;
                updateTimestampDisplay();
            }
            
            // Real-time updates: reload fresh data from server to ensure consistency
            // This avoids client-side role filtering duplication
            console.log('üîÑ Real-time update received, reloading server data...');
            loadInitialData();
            
            // Show update notification
            showUpdateNotification(
                `Updated with ${data.summary.total_count} opportunities (${data.summary.positive_ev_count} positive EV)`,
                'success'
            );
        }
    } catch (error) {
        console.error('Error processing update:', error);
        showUpdateNotification('Error processing update', 'warning');
    }
}

function connectWebSocket() {
    try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/ev`;
        
        wsConnection = new WebSocket(wsUrl);
        
        wsConnection.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            showUpdateNotification('Real-time updates connected', 'success');
            
            // Update timestamp display
            const timestampDisplay = document.getElementById('last-update-display');
            if (timestampDisplay) {
                timestampDisplay.innerHTML = '<i class="fas fa-clock me-1"></i><span>Waiting for updates...</span>';
            }
        };
        
        wsConnection.onmessage = function(event) {
            console.log('WebSocket message received');
            const data = JSON.parse(event.data);
            updateTableWithNewData(data);
        };
        
        wsConnection.onclose = function() {
            console.log('WebSocket disconnected');
            wsConnection = null;
            showUpdateNotification('Real-time connection lost, switching to fallback...', 'warning');
            
            // Fallback to SSE
            setTimeout(connectSSE, 1000);
        };
        
        wsConnection.onerror = function(error) {
            console.error('WebSocket error:', error);
            showUpdateNotification('WebSocket connection failed', 'warning');
        };
        
    } catch (error) {
        console.error('Failed to create WebSocket connection:', error);
        connectSSE();
    }
}

function connectSSE() {
    try {
        if (sseConnection) {
            sseConnection.close();
        }
        
        sseConnection = new EventSource('/sse/ev');
        
        sseConnection.onopen = function() {
            console.log('SSE connected');
            showUpdateNotification('Real-time updates connected (SSE)', 'info');
            
            // Update timestamp display
            const timestampDisplay = document.getElementById('last-update-display');
            if (timestampDisplay) {
                timestampDisplay.innerHTML = '<i class="fas fa-clock me-1"></i><span>Waiting for updates...</span>';
            }
        };
        
        sseConnection.onmessage = function(event) {
            console.log('SSE message received');
            const data = JSON.parse(event.data);
            
            // Skip connection confirmation messages
            if (data.type === 'connection') {
                return;
            }
            
            updateTableWithNewData(data);
        };
        
        sseConnection.onerror = function(error) {
            console.error('SSE error:', error);
            sseConnection.close();
            sseConnection = null;
            
            // Retry with exponential backoff
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.pow(2, reconnectAttempts) * 1000;
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectWebSocket, delay);
            } else {
                showUpdateNotification('Real-time updates unavailable', 'warning');
    }
        };
        
    } catch (error) {
        console.error('Failed to create SSE connection:', error);
        showUpdateNotification('Real-time updates unavailable', 'warning');
    }
}

// ===========================
// INITIALIZATION
// ===========================

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize client-side filtering
    initializeFiltering();
    
    // Only connect real-time updates if we're on a page with opportunities
    const opportunitiesContainer = document.querySelector('.cards-grid');
    if (opportunitiesContainer) {
        console.log('Initializing dashboard...');
        
        // Load initial data from server
        loadInitialData();
        
        // Create timestamp display
        createTimestampDisplay();
        
        // Connect to real-time updates
        connectWebSocket();
        
        // Update timestamp display every 5 seconds
        setInterval(updateTimestampDisplay, 5000);
    }
    
    // Cleanup connections when page unloads
    window.addEventListener('beforeunload', function() {
        if (wsConnection) {
            wsConnection.close();
        }
        if (sseConnection) {
            sseConnection.close();
    }
    });
});

// Trigger manual refresh (dev mode only)
async function triggerManualRefreshDev() {
    const button = document.getElementById('manual-refresh-btn');
    if (!button) return;
    
    // Show loading state
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    button.disabled = true;
    
    try {
        console.log('üîÑ Triggering manual refresh...');
        
        // Trigger server-side refresh
        const response = await fetch('/debug/trigger-refresh', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Manual refresh result:', result);
        
        if (result.status === 'success' && result.filtered_data) {
            // Update opportunities with server-filtered data
            originalOpportunities = result.filtered_data.opportunities || [];
            
            // Re-render with the new data
            renderOpportunities(originalOpportunities);
            
            // Update analytics
            updateAnalyticsDisplay(originalOpportunities);
            
            // Update results count
            updateResultsCount(originalOpportunities.length, originalOpportunities.length);
            
            // Show success notification
            showUpdateNotification(
                `‚úÖ Refresh complete: ${result.opportunities_count} opportunities loaded`,
                'success'
            );
            
            console.log(`‚úÖ Manual refresh successful: ${result.opportunities_count} opportunities for ${result.role} user`);
        } else {
            // Fallback: reload page if server response is pending
            showUpdateNotification('üîÑ Refresh in progress, reloading page...', 'info');
            setTimeout(() => window.location.reload(), 2000);
        }
        
    } catch (error) {
        console.error('‚ùå Manual refresh failed:', error);
        showUpdateNotification('‚ùå Manual refresh failed: ' + error.message, 'danger');
    } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
}
</script>
{% endblock %} 