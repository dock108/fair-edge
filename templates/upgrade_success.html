{% extends "base.html" %}

{% block title %}Upgrade Successful - Sports Betting +EV Analyzer{% endblock %}

{% block head %}
<meta name="description" content="Welcome to Premium! Your subscription upgrade was successful.">
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Loading State -->
            <div id="loading-state" class="text-center">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h3>Processing your upgrade...</h3>
                <p class="text-muted">Please wait while we confirm your subscription.</p>
            </div>

            <!-- Success State -->
            <div id="success-state" class="text-center d-none">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h1 class="display-4 fw-bold text-success mb-3">Welcome to Premium!</h1>
                <p class="lead mb-4">Your subscription upgrade was successful. You now have access to all Premium features.</p>
                
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-infinity text-success mb-2" style="font-size: 2rem;"></i>
                                <h5>Unlimited Opportunities</h5>
                                <p class="text-muted small">Access all betting opportunities without limits</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line text-success mb-2" style="font-size: 2rem;"></i>
                                <h5>Advanced Analytics</h5>
                                <p class="text-muted small">Detailed insights and confidence scoring</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-download text-success mb-2" style="font-size: 2rem;"></i>
                                <h5>Export Data</h5>
                                <p class="text-muted small">Download opportunities to CSV/Excel</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="/" class="btn btn-success btn-lg me-md-2">
                        <i class="fas fa-chart-bar me-2"></i>
                        Start Using Premium Features
                    </a>
                    <a href="/api/billing/subscription-status" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-user me-2"></i>
                        View Subscription Details
                    </a>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center d-none">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                </div>
                <h1 class="display-5 fw-bold text-warning mb-3">Processing Your Upgrade</h1>
                <p class="lead mb-4">Your payment was successful, but we're still processing your account upgrade. This usually takes just a few moments.</p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>What's happening?</strong> We're updating your account with Premium access. You should see your new features within 1-2 minutes.
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button onclick="checkSubscriptionStatus()" class="btn btn-primary btn-lg me-md-2">
                        <i class="fas fa-sync-alt me-2"></i>
                        Check Status Again
                    </button>
                    <a href="/" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-home me-2"></i>
                        Go to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script>
let checkAttempts = 0;
const maxAttempts = 10;

async function checkSubscriptionStatus() {
    try {
        // Refresh the user session first
        await refreshUserSession();
        
        // Get current user info with fresh data
        const response = await authenticatedFetch('/me', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const user = await response.json();
            
            if (user.role === 'subscriber' && user.subscription_status === 'active') {
                // Success! Show success state
                showSuccessState();
                return true;
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error checking subscription status:', error);
        return false;
    }
}

async function refreshUserSession() {
    try {
        // Try to refresh the Supabase session to get latest user data
        if (window.supabase && window.supabase.auth) {
            const { data, error } = await window.supabase.auth.refreshSession();
            if (error) {
                console.warn('Session refresh failed:', error);
            } else {
                console.log('Session refreshed successfully');
            }
        }
    } catch (error) {
        console.error('Error refreshing session:', error);
    }
}

function showSuccessState() {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('error-state').classList.add('d-none');
    document.getElementById('success-state').classList.remove('d-none');
    
    // Show celebration animation
    if (window.confetti) {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
    }
}

function showErrorState() {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('success-state').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
}

async function pollSubscriptionStatus() {
    checkAttempts++;
    
    console.log(`Polling attempt ${checkAttempts}/${maxAttempts}...`);
    
    const isUpgraded = await checkSubscriptionStatus();
    
    if (isUpgraded) {
        console.log('✅ Account successfully upgraded!');
        return; // Success, stop polling
    }
    
    if (checkAttempts >= maxAttempts) {
        // Max attempts reached, show delayed processing state
        console.log('⏰ Max polling attempts reached, showing delayed processing message');
        showErrorState();
        return;
    }
    
    // Continue polling every 3 seconds (Stripe events usually arrive <3s)
    setTimeout(pollSubscriptionStatus, 3000);
}

// Start checking subscription status when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get session ID from URL if present for debugging
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    if (sessionId) {
        console.log('Stripe checkout session ID:', sessionId);
    }
    
    // Show helpful loading message
    const loadingState = document.getElementById('loading-state');
    if (loadingState) {
        // Add progress indicator
        let dots = 0;
        const progressInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            const loadingText = loadingState.querySelector('h3');
            if (loadingText) {
                loadingText.textContent = 'Processing your upgrade' + '.'.repeat(dots);
            }
        }, 500);
        
        // Clear progress when done
        setTimeout(() => clearInterval(progressInterval), 30000);
    }
    
    // Start polling after a brief delay
    setTimeout(pollSubscriptionStatus, 1000);
});
</script>

<!-- Add confetti for celebration -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
{% endblock %} 