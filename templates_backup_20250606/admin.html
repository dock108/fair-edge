{% extends "base.html" %}

{% block title %}Admin Dashboard - Sports Betting +EV Analyzer{% endblock %}

{% block extra_head %}
<style>
    .admin-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    
    .admin-header {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 2rem;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }
    
    .admin-content {
        padding: 2rem;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #495057;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .users-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .table th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    
    .role-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .role-admin { background: #dc3545; color: white; }
    .role-subscriber { background: #28a745; color: white; }
    .role-free { background: #6c757d; color: white; }
    
    .subscription-active { color: #28a745; font-weight: 600; }
    .subscription-inactive { color: #6c757d; }
    
    .search-filters {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .system-metrics {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 500;
    }
    
    .metric-value {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 0.375rem;
        margin: 1rem 0;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 0.375rem;
        margin: 1rem 0;
    }
    
    .nav-tabs .nav-link.active {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .nav-tabs .nav-link {
        color: #dc3545;
        border-color: transparent;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="admin-container">
        <div class="admin-header">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-1">
                        <i class="fas fa-shield-alt me-2"></i>
                        Admin Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">System management and user administration</p>
                </div>
                <div class="col-auto">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-shield me-2"></i>
                        <span id="admin-user-email">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- Alert container for messages -->
            <div id="alert-container"></div>
            
            <!-- Navigation tabs -->
            <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" 
                            type="button" role="tab" aria-controls="users" aria-selected="true">
                        <i class="fas fa-users me-2"></i>Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" 
                            type="button" role="tab" aria-controls="stats" aria-selected="false">
                        <i class="fas fa-chart-bar me-2"></i>System Stats
                    </button>
                </li>
            </ul>
            
            <!-- Tab content -->
            <div class="tab-content" id="adminTabsContent">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                    <!-- Search and filters -->
                    <div class="search-filters">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="user-search" class="form-label">Search by Email</label>
                                <input type="text" class="form-control" id="user-search" 
                                       placeholder="Enter email to search...">
                            </div>
                            <div class="col-md-3">
                                <label for="role-filter" class="form-label">Filter by Role</label>
                                <select class="form-select" id="role-filter">
                                    <option value="">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="subscriber">Subscriber</option>
                                    <option value="free">Free</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary me-2" onclick="searchUsers()">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users table -->
                    <div class="users-table">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Subscription</th>
                                        <th>Created</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 mb-0">Loading users...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Users pagination" class="p-3">
                            <ul class="pagination justify-content-center mb-0" id="users-pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
                
                <!-- System Stats Tab -->
                <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                    <!-- Overview cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="total-users">-</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="active-subscribers">-</div>
                                <div class="stat-label">Active Subscribers</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="cached-opportunities">-</div>
                                <div class="stat-label">Cached Opportunities</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="system-uptime">-</div>
                                <div class="stat-label">System Uptime</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed metrics -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="system-metrics">
                                <h5 class="mb-3">
                                    <i class="fas fa-database me-2"></i>Cache Statistics
                                </h5>
                                <div id="cache-metrics">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="system-metrics">
                                <h5 class="mb-3">
                                    <i class="fas fa-chart-line me-2"></i>Performance Metrics
                                </h5>
                                <div id="performance-metrics">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <div class="system-metrics">
                                <h5 class="mb-3">
                                    <i class="fas fa-users me-2"></i>User Statistics
                                </h5>
                                <div id="user-metrics">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="system-metrics">
                                <h5 class="mb-3">
                                    <i class="fas fa-cogs me-2"></i>Application Info
                                </h5>
                                <div id="app-metrics">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Refresh button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary" onclick="refreshStats()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Statistics
                        </button>
                        <span class="ms-3 text-muted small" id="stats-last-updated">
                            Last updated: <span id="stats-timestamp">Never</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Change Modal -->
<div class="modal fade" id="roleChangeModal" tabindex="-1" aria-labelledby="roleChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleChangeModalLabel">Change User Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="role-change-form">
                    <input type="hidden" id="change-user-id">
                    <div class="mb-3">
                        <label for="change-user-email" class="form-label">User Email</label>
                        <input type="email" class="form-control" id="change-user-email" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="new-role" class="form-label">New Role</label>
                        <select class="form-select" id="new-role" required>
                            <option value="">Select a role...</option>
                            <option value="admin">Admin</option>
                            <option value="subscriber">Subscriber</option>
                            <option value="free">Free</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="change-reason" class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" id="change-reason" rows="3" 
                                  placeholder="Enter reason for role change..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRoleChange()">
                    <i class="fas fa-save me-1"></i>Update Role
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='/js/admin.js') }}"></script>
{% endblock %} 