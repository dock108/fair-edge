<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time sports betting +EV analysis dashboard">
    <title>{% block title %}{{ page_title or "Sports Betting +EV Analyzer" }}{% endblock %}</title>
    
    <!-- CSS Framework and Custom Styles -->
    <!-- Design Tokens - MUST load first -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/_tokens.css') }}">
    <!-- Layout Utilities - MUST load after tokens -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/_layout.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/dashboard.css') }}">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Alpine.js for interactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Graceful degradation: Auto-refresh for browsers without JavaScript -->
    <noscript>
        <!-- Refresh the whole page every 60s when JavaScript is unavailable -->
        <meta http-equiv="refresh" content="60">
    </noscript>
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Header Section - COMMENTED OUT: Replaced with hero banner in dashboard.html -->
    <!--
    <header class="header-section">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="header-content text-center py-4">
                        <h1 class="header-title">
                            <i class="fas fa-crosshairs me-2"></i>
                            Sports Betting +EV Analyzer
                        </h1>
                        <p class="header-subtitle mb-2">
                            Real-time identification of positive expected value betting opportunities
                        </p>
                        <small class="header-tagline">
                            Professional-grade analysis ‚Ä¢ Live market data ‚Ä¢ Smart filtering
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </header>
    -->

    <!-- Navigation Bar (Updated to use content-wrap) -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="content-wrap d-flex justify-content-between align-items-center">
            <div class="navbar-nav">
                <a class="nav-link active" href="/">
                    <i class="fas fa-home me-1"></i> Dashboard
                </a>
                <a class="nav-link" href="/education">
                    <i class="fas fa-graduation-cap me-1"></i> Education
                </a>
                <a class="nav-link" href="/pricing">
                    <i class="fas fa-tags me-1"></i> Pricing
                </a>
                <a class="nav-link" href="/disclaimer">
                    <i class="fas fa-exclamation-triangle me-1"></i> Disclaimer
                </a>
                <!-- Admin link - only visible for admin users -->
                {% if user_role == 'admin' %}
                <a class="nav-link" href="/admin">
                    <i class="fas fa-shield-alt me-1"></i> Admin
                </a>
                {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- DEBUG: Manual Refresh Button -->
                {% if settings.debug_mode %}
                <button id="manual-refresh-dev-btn" onclick="triggerManualRefreshDev()" class="btn btn-outline-warning btn-sm">
                    <i class="fas fa-sync-alt me-1"></i> Manual Refresh (Dev)
                </button>
                {% endif %}

                <!-- Authentication status will be populated by JavaScript -->
                <div id="auth-status">
                    <a class="nav-link" href="/login">
                        <i class="fas fa-sign-in-alt me-1"></i> Login
                    </a>
                </div>

                <!-- Admin Badge Only -->
                {% if user_role == 'admin' %}
                <span class="badge bg-danger rounded-pill">
                    <i class="fas fa-shield-alt me-1"></i>Admin
                </span>
                {% endif %}
                
                <!-- Manage Billing Button for Subscribers -->
                {% if user_role == 'subscriber' %}
                <button id="manage" onclick="manageBilling()" class="btn btn-outline-primary btn-sm d-none" id="manage-billing-nav">
                    <i class="fas fa-credit-card me-1"></i>
                    Manage billing
                </button>
                {% endif %}
                
                <!-- Upgrade CTA for free users -->
                <button onclick="goPremium()" class="btn btn-warning btn-sm px-3 py-1 rounded-pill fw-bold d-none" id="upgrade-cta" style="box-shadow: 0 2px 4px rgba(255,193,7,0.3);">
                    <i class="fas fa-star me-1"></i> Upgrade
                </button>
                
                <!-- Account link for authenticated users -->
                <a class="nav-link d-none" href="/account" id="account-link">
                    <i class="fas fa-user me-1"></i> My Account
                </a>
            </div>
        </div>
    </nav>

            {% block content %}
            <!-- Page-specific content will be inserted here -->
            {% endblock %}

    <!-- Footer (Updated to use content-wrap) -->
    <footer class="footer mt-5 py-3 bg-light">
        <div class="content-wrap">
            <div class="text-center">
                    <small class="text-muted">
                        Sports Betting +EV Analyzer v2.1.0 | 
                        <span id="last-updated">Last updated: <span class="fw-bold">Just now</span></span> |
                        <a href="/education" class="text-muted text-decoration-none" title="Learn about sports betting basics">üìö Learn the Basics</a> |
                        <a href="/disclaimer" class="text-muted text-decoration-none" title="Important legal disclaimer and risk disclosure">‚ö†Ô∏è Disclaimer</a>
                    </small>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        window.supabase = supabase.createClient(
            "{{ settings.supabase_url }}",
            "{{ settings.supabase_anon_key }}"
        );
    </script>
    
    <!-- Custom JavaScript -->
    {% block scripts %}{% endblock %}
    
    <script src="{{ url_for('static', path='/js/auth.js') }}"></script>
    <script src="{{ url_for('static', path='/js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', path='/js/layout.js') }}"></script>
    
    <!-- Upgrade Flow JavaScript -->
    <script>
        // Seamless upgrade flow function
        async function goPremium() {
            const upgradeBtn = document.querySelector('#upgrade-cta button');
            const originalContent = upgradeBtn.innerHTML;
            
            try {
                // Show loading state
                upgradeBtn.disabled = true;
                upgradeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
                
                // Check if user is authenticated
                const user = await getCurrentUser();
                if (!user) {
                    // Redirect to login with upgrade intent
                    window.location.href = '/login?intent=upgrade';
                    return;
                }
                
                // Check if already a subscriber
                if (user.role === 'subscriber' && user.subscription_status === 'active') {
                    showToast('You are already a Premium subscriber!', 'info');
                    return;
                }
                
                // Create Stripe checkout session
                const response = await authenticatedFetch('/api/billing/create-checkout-session', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to create checkout session');
                }
                
                const data = await response.json();
                
                // Redirect to Stripe Checkout
                window.location.replace(data.checkout_url);
                
            } catch (error) {
                console.error('Error upgrading to premium:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Reset button state
                upgradeBtn.disabled = false;
                upgradeBtn.innerHTML = originalContent;
            }
        }
        
        // Show premium feature gate toast
        function showPremiumGate(featureName) {
            showToast(`${featureName} is available on Premium`, 'warning');
            // Animate the upgrade button
            const upgradeBtn = document.querySelector('#upgrade-cta button');
            if (upgradeBtn) {
                upgradeBtn.classList.add('animate__animated', 'animate__pulse');
                setTimeout(() => {
                    upgradeBtn.classList.remove('animate__animated', 'animate__pulse');
                }, 1000);
            }
        }
        
        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove from DOM after hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
        
        // Create toast container if it doesn't exist
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
            return container;
        }
        
        // Update auth status and show/hide upgrade CTAs
        function updateUpgradeVisibility(user) {
            const upgradeCTA = document.getElementById('upgrade-cta');
            const upgradeBanner = document.getElementById('upgrade-banner');
            const accountLink = document.getElementById('account-link');
            const manageBillingNav = document.getElementById('manage-billing-nav');
            
            if (user && user.role === 'free') {
                // Show upgrade CTA for free users
                if (upgradeCTA) upgradeCTA.classList.remove('d-none');
                // Show account link for authenticated users
                if (accountLink) accountLink.classList.remove('d-none');
                // Hide manage billing for free users
                if (manageBillingNav) manageBillingNav.classList.add('d-none');
            } else if (user && user.role === 'subscriber') {
                // Hide upgrade CTA for premium users
                if (upgradeCTA) upgradeCTA.classList.add('d-none');
                // Show account link for authenticated users
                if (accountLink) accountLink.classList.remove('d-none');
                // Show manage billing for subscribers
                if (manageBillingNav) manageBillingNav.classList.remove('d-none');
            } else {
                // Hide all for guests/unauthenticated users
                if (upgradeCTA) upgradeCTA.classList.add('d-none');
                if (accountLink) accountLink.classList.add('d-none');
                if (manageBillingNav) manageBillingNav.classList.add('d-none');
            }
        }
        
        // Manage billing via Customer Portal (specification pattern)
        async function manageBilling() {
            const btn = document.getElementById('manage');
            if (!btn) return;
            
            const originalContent = btn.innerHTML;
            
            try {
                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Opening...';
                
                // Create portal session
                const res = await authenticatedFetch(
                    "/api/billing/create-portal-session",
                    {method:"POST", credentials:"include"}
                );
                
                if (res.ok) {
                    const {url} = await res.json();
                    location.href = url;  // redirect to Stripe portal
                } else {
                    alert("Could not open billing portal‚Äîplease try again.");
                }
            } catch (error) {
                console.error('Error opening billing portal:', error);
                alert("Could not open billing portal‚Äîplease try again.");
            } finally {
                // Reset button state
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const user = await getCurrentUser();
                updateUpgradeVisibility(user);
            } catch (error) {
                // User not authenticated - hide upgrade CTA
                updateUpgradeVisibility(null);
            }
        });
    </script>
</body>
</html> 